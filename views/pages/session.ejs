<!-- Session Detail Header -->
<div class="mb-6">
    <a href="/" class="inline-flex items-center gap-2 text-sm text-gray-500 hover:text-primary-500 mb-3">
        <i class="fa-solid fa-arrow-left"></i>
        Back to sessions
    </a>

    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-4">
        <div class="flex items-center justify-between mb-3">
            <h1 class="font-semibold text-lg" x-text="session?.summary || 'Session'"></h1>
            <div class="flex items-center gap-2">
                <!-- Filter: Only User -->
                <button @click="showOnlyUser = !showOnlyUser"
                        :class="showOnlyUser ? 'bg-primary-100 dark:bg-primary-900/50 text-primary-600' : 'bg-gray-100 dark:bg-slate-700'"
                        class="px-3 py-1.5 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors text-sm">
                    <i class="fa-solid fa-user mr-1"></i>
                    <span class="hidden sm:inline">Only mine</span>
                </button>

                <!-- Filter: Only Tagged -->
                <button @click="showOnlyTagged = !showOnlyTagged; if(!showOnlyTagged) filterTag = null"
                        :class="[
                            showOnlyTagged ? 'bg-primary-100 dark:bg-primary-900/50' : 'bg-gray-100 dark:bg-slate-700',
                            taggedCount > 0 ? 'text-primary-600' : 'text-gray-400'
                        ]"
                        class="px-3 py-1.5 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors text-sm">
                    <i class="fa-solid fa-tag"></i>
                    <span class="ml-1" x-show="taggedCount > 0" x-text="taggedCount"></span>
                </button>
            </div>
        </div>

        <!-- Session Meta -->
        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
            <span>
                <i class="fa-solid" :class="getToolIcon(session?.tool)"></i>
                <span class="ml-1" x-text="getToolName(session?.tool)"></span>
            </span>
            <span>
                <i class="fa-solid fa-folder mr-1"></i>
                <span x-text="session?.project?.split('/').pop()"></span>
            </span>
            <span>
                <i class="fa-regular fa-calendar mr-1"></i>
                <span x-text="formatDateTime(session?.started_at)"></span>
            </span>
            <span>
                <i class="fa-regular fa-message mr-1"></i>
                <span x-text="session?.message_count || 0"></span> messages
            </span>
        </div>

        <!-- Tag Filter (shows when tagged filter is active) -->
        <div x-show="showOnlyTagged && taggedCount > 0" x-cloak class="flex items-center gap-1 mt-3 pt-3 border-t border-gray-200 dark:border-slate-700">
            <span class="text-xs text-gray-400 mr-2">Filter by tag:</span>
            <template x-for="tag in tags" :key="tag.id">
                <button @click="filterTag = filterTag === tag.id ? null : tag.id"
                        :class="filterTag === tag.id ? 'bg-primary-500 text-white' : 'bg-gray-100 dark:bg-slate-700 hover:bg-gray-200'"
                        class="px-2 py-1 rounded text-xs font-medium transition-colors">
                    <span x-text="tag.label"></span>
                    <span class="opacity-75" x-text="'(' + getTagCount(tag.id) + ')'"></span>
                </button>
            </template>
        </div>
    </div>
</div>

<!-- Loading -->
<div x-show="loading" class="text-center py-12">
    <i class="fa-solid fa-spinner fa-spin text-4xl text-primary-500"></i>
    <p class="mt-4 text-gray-500">Loading messages...</p>
</div>

<!-- Messages -->
<div x-show="!loading" class="space-y-4">
    <template x-for="message in messages" :key="message.id">
        <article x-show="isMessageVisible(message.id, message.type)"
                 :id="'msg-' + message.id"
                 class="relative">

            <!-- Message Card -->
            <div :class="[
                    message.type === 'user'
                        ? 'bg-primary-50 dark:bg-primary-900/30 border-primary-200 dark:border-primary-800 ml-8'
                        : 'bg-white dark:bg-slate-800 border-gray-200 dark:border-slate-700 mr-8',
                    hasAnyTag(message.id) ? 'ring-2 ring-primary-300 dark:ring-primary-600' : ''
                 ]"
                 class="rounded-xl border shadow-sm overflow-hidden">

                <!-- Message Header -->
                <div :class="message.type === 'user'
                        ? 'border-primary-200 dark:border-primary-800 bg-primary-100/50 dark:bg-primary-900/50'
                        : 'border-gray-100 dark:border-slate-700 bg-gray-50 dark:bg-slate-700/50'"
                     class="px-4 py-2 border-b flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <template x-if="message.type === 'user'">
                            <span class="flex items-center gap-2">
                                <i class="fa-solid fa-user text-primary-500"></i>
                                <span class="font-medium text-sm text-primary-700 dark:text-primary-300">You</span>
                            </span>
                        </template>
                        <template x-if="message.type !== 'user'">
                            <span class="flex items-center gap-2">
                                <i class="fa-solid" :class="getToolIcon(session?.tool)"></i>
                                <span class="font-medium text-sm" x-text="getToolName(session?.tool)"></span>
                            </span>
                        </template>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-400" x-text="formatDateTime(message.timestamp)"></span>
                        <!-- Tag toggle button -->
                        <button @click="showTagPicker = showTagPicker === message.id ? null : message.id"
                                class="p-1 rounded hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors">
                            <i class="fa-solid fa-tag" :class="hasAnyTag(message.id) ? 'text-primary-500' : 'text-gray-300'"></i>
                        </button>
                    </div>
                </div>

                <!-- Inline Tag Chips -->
                <div x-show="hasAnyTag(message.id) || showTagPicker === message.id" x-cloak
                     class="px-4 py-2 bg-gray-50 dark:bg-slate-700/50 border-b border-gray-100 dark:border-slate-700 flex flex-wrap items-center gap-1">
                    <template x-for="tag in tags" :key="tag.id">
                        <button @click="toggleTag(message.id, tag.id)"
                                :class="hasTag(message.id, tag.id) ? 'bg-primary-500 text-white' : 'bg-gray-200 dark:bg-slate-600 hover:bg-gray-300 dark:hover:bg-slate-500'"
                                class="px-2 py-0.5 rounded text-xs font-medium transition-colors">
                            <span x-text="tag.label"></span>
                        </button>
                    </template>
                </div>

                <!-- Thinking Block (if exists) -->
                <template x-if="message.thinking">
                    <div class="border-b border-gray-100 dark:border-slate-700">
                        <button @click="expandedThinking[message.id] = !expandedThinking[message.id]"
                                class="w-full px-4 py-2 text-left text-sm flex items-center gap-2
                                       text-amber-600 dark:text-amber-400 hover:bg-amber-50 dark:hover:bg-amber-900/20
                                       transition-colors">
                            <i class="fa-solid fa-brain"></i>
                            <span>Thinking</span>
                            <i class="fa-solid fa-chevron-down ml-auto transition-transform"
                               :class="expandedThinking[message.id] ? 'rotate-180' : ''"></i>
                        </button>
                        <div x-show="expandedThinking[message.id]"
                             x-cloak
                             class="px-4 py-3 bg-amber-50/50 dark:bg-amber-900/10 max-h-72 overflow-y-auto">
                            <pre class="text-xs text-amber-800 dark:text-amber-200 whitespace-pre-wrap font-mono" x-text="message.thinking"></pre>
                        </div>
                    </div>
                </template>

                <!-- Message Content -->
                <div class="px-4 py-3">
                    <div class="message-content text-sm" x-text="message.content"></div>
                </div>
            </div>
        </article>
    </template>
</div>

<!-- Empty State -->
<div x-show="!loading && messages.length === 0"
     class="text-center py-12 text-gray-500 dark:text-gray-400">
    <i class="fa-solid fa-inbox text-4xl mb-4 opacity-50"></i>
    <p>No messages found</p>
</div>
